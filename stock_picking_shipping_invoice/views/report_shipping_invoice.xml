<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <template id="report_shipping_invoice">
        <t t-call="web.html_container">
            <t t-call="stock_picking_shipping_invoice.external_layout">
                <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)" />
                <t t-set="partner" t-value="o.partner_id or (o.move_lines and o.move_lines[0].partner_id) or False"/>
                <div class="row">
                  <div class="col-6">
                    <table class="table-sm border-black" width="90%">
                      <tr>
                        <td class="bg-light"><strong>Customer</strong></td>
                      </tr>
                      <tr>
                        <td>
                          <div class="container">
                            <div id="seller">
                              <div class="row">
                                <span t-field="o.sale_id.partner_id"
                                      t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True, "phone_icons": True}'/>
                              </div>
                              <div class="row" t-if="o.sale_id.partner_id.email">
                                <i class="fa fa-envelope-o fa-fw"/><span t-field="o.sale_id.partner_id.email"/>
                              </div>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </table>
                  </div>
                  <div class="col-6">
                    <table class="table-sm border-black pull-right" width="100%">
                      <tr>
                        <td class="bg-light"><strong>Information</strong></td>
                      </tr>
                      <tr>
                        <td id="information">
                          <div class="container">
                            <div class="pull-right">
                              <div class="row">
                                <span>Date: </span>
                                <t t-if="o.state == 'done'">
                                  <span t-field="o.date_done" class="m-0" t-options='{"widget": "date"}'/>
                                </t>
                                <t t-if="o.state != 'done'">
                                  <span t-field="o.scheduled_date" class="m-0" t-options='{"widget": "date"}'/>
                                </t>
                              </div>
                              <div class="row">
                                <span>Shipper: </span>
                                <span t-field="o.company_id" class="m-0"/>
                              </div>
                              <div class="row">
                                <span>Shipper Contact: </span>
                                <span t-field="o.sale_id.user_id.partner_id.name" class="m-0"/>
                              </div>
                              <div t-if="o.origin" class="row">
                                <span>Source Document: </span>
                                <span t-field="o.origin"/>
                              </div>
                              <div t-else="" class="row">
                                <span>Sales Order: </span>
                                <span t-field="o.sale_id.name"/>
                              </div>
                              <div t-if="o.client_order_ref" class="row">
                                <span>Customer Reference: </span>
                                <span t-field="o.client_order_ref"/>
                              </div>
                              <div t-if="o.sale_id.incoterm" class="row">
                                <span>Incoterms: </span>
                                <span t-field="o.sale_id.incoterm"/>
                              </div>                    
                            </div>
                          </div>
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
                <div class="row">
                  <div class="col-6">
                    <table class="table-sm border-black" width="90%">
                      <tr>
                        <td class="bg-light"><strong>Consignee</strong></td>
                      </tr>
                      <tr>
                        <td>
                          <div class="container">
                            <t t-if="o.partner_id.parent_id">
                              <div class="row">
                                <div t-field="o.partner_id.parent_id"
                                     t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True, "phone_icons": True}'/>
                              </div>
                              <div class="row">
                                <span>Contact: </span><span t-field="o.partner_id.name"/>
                                <t t-if="o.partner_id.mobile"><i class="fa fa-mobile"/><span t-field="o.partner_id.mobile" class="m-0"/></t>
                              </div>
                            </t>
                            <t t-else="">
                              <div class="row">
                                <div t-field="o.partner_id"
                                     t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True, "phone_icons": True}'/>
                              </div>
                            </t>
                            <div class="row" t-if="o.partner_id.email">
                              <i class="fa fa-envelope-o fa-fw"/><span t-field="o.partner_id.email"/>
                            </div>
                          </div>
                        </td>
                      </tr>
                    </table>
                  </div>
                  <div class="col-6">
                    <table class="table-sm border-black pull-right" width="100%">
                      <tr>
                        <td class="bg-light"><strong>Shipment Information</strong></td>
                      </tr>
                      <tr>
                        <td>
                          <div class="container" name="shipment">
                            <t t-if="o.note">
                              <div class="row">
                                <strong><p t-field="o.note"/></strong>
                              </div>
                            </t>
                          </div>
                        </td>
                      </tr>
                    </table>
                  </div>
                </div>
                <div class="clearfix"/>
                <div class="page">                    
                    <table class="table table-sm mt48">
                        <t t-set="has_serial_number" t-value="o.move_line_ids.mapped('lot_id')" />
                        <thead>
                            <tr class="text-nowrap">
                              <th><strong>Line #</strong></th>
                              <th><strong>Item #</strong></th>
                                <th><strong>Product</strong></th>
                                <th>HS Code</th>
                                <th name="lot_serial" t-if="has_serial_number" groups="stock.group_lot_on_delivery_slip">
                                    Lot/Serial Number
                                </th>
                                <th class="text-right"><strong>Quantity</strong></th>
                              <th class="text-right"><strong>Unit Price</strong></th>
                              <th class="text-right"><strong>Total</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                          <t t-set="move_package" t-value="[]"/>
                          <t t-set="shipped_qty" t-value="0"/>
                          <t t-set="product_uom" t-value="[]"/>
                          <t t-foreach="o.move_line_ids" t-as="move_line">
                            <t t-set="move_package" t-value="move_package+[move_line.result_package_id]"/>
                            <t t-set="shipped_qty" t-value="shipped_qty+move_line.qty_done"/>
                            <t t-set="product_uom" t-value="move_line.product_uom_id.name"/>
                          </t>
                          <t t-set="pkg_qty" t-value="0"/>
                          <t t-set="pkg_vol" t-value="0"/>
                          <t t-set="pkg_weight" t-value="0"/>
                          <t t-foreach="sorted(set(move_package), key=lambda k: k.name)" t-as="package">
                            <t t-set="move_move" t-value="[]"/>
                            <t t-foreach="o.move_line_ids.filtered(lambda l: l.result_package_id.id==package.id)" t-as="move">
                              <t t-set="move_move" t-value="move_move+[move.move_id]"/>
                            </t>
                            <t t-foreach="sorted(set(move_move), key=lambda k: k.id)" t-as="move_line">
                              <t t-set="move_qty" t-value="0"/>
                              <t t-set="move_lot" t-value="[]"/>
                              <t t-foreach="o.move_line_ids.filtered(lambda x: x.move_id.id==move_line.id and x.result_package_id.id==package.id)" t-as="product">
                                <t t-set="move_qty" t-value="move_qty+product.qty_done"/>
                                <t t-set="move_lot" t-value="move_lot+[product.lot_id]"/>
                              </t>
                              <tr>
                                <td>
                                  <span t-field="move_line.sequence"/>
                                </td>
                                <td>
                                  <span t-field="move_line.item"/>
                                </td>
                                <td>
                                  <span t-field="move_line.product_id"/>
                                  <p t-if="o.picking_type_code == 'outgoing'">
                                    <span t-field="move_line.product_id.sudo().description_pickingout"/>
                                  </p>
                                  <p t-if="o.picking_type_code == 'incoming'">
                                    <span t-field="move_line.product_id.sudo().description_pickingin"/>
                                  </p>
                                </td>
                                <td><span t-field="move_line.product_id.hs_code"/></td>
                                <td width="20%" t-if="has_serial_number and o.show_serial" groups="stock.group_lot_on_delivery_slip">
                                  <t t-foreach="sorted(set(move_lot), key=lambda k: k.name)" t-as="lot">
                                    <span t-esc="lot.name"/>
                                  </t>
                                </td>
                                <td class="text-right text-nowrap">
                                  <span t-if="o.state=='done'" t-esc="move_qty"/>
                                  <span t-else="" t-esc="move_line.product_uom_qty"/>
                                  <span t-field="move_line.product_uom"/>
                                </td>
                                <td class="text-right text-nowrap">
                                  <span t-if="move_line.price_unit" t-field="move_line.price_unit"/>
                                  <span t-else="" t-field="move_line.sale_line_id.price_unit"/>
                                </td>                               
                                <td class="text-right text-nowrap">
                                  <span t-if="move_line.price_unit" t-esc="move_line.price_unit * move_line.product_uom_qty"/>
                                  <span t-else="" t-esc="move_line.sale_line_id.price_unit * move_line.product_uom_qty"/>
                                </td>    
                              </tr>
                            </t>
                          </t>
                        </tbody>
                    </table>
                    <p>
                        <t t-if="o.backorder_ids and o.backorder_ids.filtered(lambda x: x.state not in ('done', 'cancel'))">
                            All items couldn't be shipped, the remaining ones will be shipped as soon as they become available.
                        </t>
                    </p>
                </div>
            </t>
         </t>
    </template>
</odoo>
